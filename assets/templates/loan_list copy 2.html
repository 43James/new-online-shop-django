{% extends "base_sidebar.html" %}
{% load static %}
{% block content %}
<style>
    /* CSS สำหรับ Floating Cart */
    #floating-cart-wrapper {
        position: fixed; /* ทำให้ลอย */
        bottom: 20px;    /* ห่างจากด้านล่าง 20px */
        right: 50px;     /* ห่างจากด้านขวา 20px */
        z-index: 1050;   /* ให้อยู่เหนือ Modal/Navbar */
        background-color: #fff; /* ใส่พื้นหลังสีขาว */
        border: 1px solid #ddd;
        border-radius: 50%; /* ทำให้เป็นวงกลม */
        padding: 5px; /* เพิ่ม padding เล็กน้อย */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* เพิ่มเงา */
        /* กำหนดขนาดตายตัวให้กล่อง เพื่อให้ดูเป็นระเบียบ */
        width: 55px;
        height: 55px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    /* ปรับขนาดและสีของไอคอนตะกร้าให้โดดเด่น */
    #floating-cart-wrapper .bi-cart3 {
        color: #0d6efd !important; /* สีน้ำเงินหลักของ Bootstrap */
        font-size: 2.5rem !important; /* ขนาดใหญ่กว่าเดิม */
    }
    
    /* ปรับตำแหน่ง badge ให้ตรงกลางมากขึ้น */
    #floating-cart-wrapper #cart-badge {
        font-size: 0.85rem !important;
        /* ปรับตำแหน่งเพื่อชดเชยขนาดที่ใหญ่ขึ้น */
        top: 0px;
        left: 100%;
        transform: translate(-10%, -10%) !important; 
    }
</style>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>รายการครุภัณฑ์ที่ยืมได้</h3>
        <!-- <a href="{% url 'assets:loan_cart' %}" class="nav-link position-relative">
            <i class="bi bi-cart3 fs-4"></i>
            <span id="cart-badge"
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
        </a> -->
        <div class="d-flex align-items-center">
            <button type="button" class="btn btn-sm btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#helpModal">
                <i class="bi bi-question-circle"></i> วิธีใช้
            </button>
            <!-- <a href="{% url 'assets:loan_cart' %}" class="nav-link position-relative">
                <i class="bi bi-cart3 fs-4"></i>
                <span id="cart-badge"
                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
            </a> -->
        </div>
        <div id="floating-cart-wrapper">
        <a href="{% url 'assets:loan_cart' %}" class="nav-link position-relative p-2">
            <i class="bi bi-cart3 fs-1 text-primary"></i> <span id="cart-badge"
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger fs-6">0</span>
        </a>
    </div>
    </div>
    {% if request.user.is_admin or request.user.is_warehouse_manager %}
    <div class="btn-group mb-3">
        <a href="{% url 'assets:add_asset_item_loan' %}" type="button" class="btn btn-outline-success"><i
                class="bi bi-plus-circle"></i> เพิ่มรายการ</a>
    </div>
    {% endif %}

    <form method="get" class="row g-2 mb-4">
        <div class="col-md-4">
            <input type="text" name="q" class="form-control" placeholder="ค้นหาชื่อครุภัณฑ์..." value="{{ query }}">
        </div>
        <div class="col-md-3">
            <select name="category" class="form-select">
                <option value="">-- เลือกหมวดหลัก --</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if selected_category and selected_category.id == category.id %} selected {% endif %}>{{ category.name_cate }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <select name="subcategory" class="form-select">
                <option value="">-- เลือกหมวดย่อย --</option>
                {% for subcategory in subcategories %}
                <option value="{{ subcategory.id }}" {% if selected_subcategory and selected_subcategory.id == subcategory.id %}selected{% endif %}>{{ subcategory.name_sub }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary ">ค้นหา</button>
            <a href="{% url 'assets:loan_list' %}" class="btn btn-secondary">ยกเลิก</a>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <thead class="table-light text-center">
                <tr>
                    <th>รูป</th>
                    <th>ชื่อครุภัณฑ์</th>
                    <th style="width: 200px;">รหัสครุภัณฑ์</th>
                    <th>สถานที่เก็บ</th>
                    <th style="width: 350px;">การทำงาน</th>
                    {% if request.user.is_admin or request.user.is_warehouse_manager %}
                    <th style="width: 10%;">จัดการ</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody class="text-center">
                {% for asset in asset_items %}
                <tr data-id="{{ asset.id }}">
                    <td>{% if asset.asset_image %}<img src="{{ asset.asset_image.url }}"
                            style="width: 300px; object-fit:cover">{% else %} ไม่มีรูป {% endif %}</td>
                    <td>{{ asset.item_name }}</td>
                    <td>{{ asset.asset_code }}</td>
                    <td>{{ asset.storage_location }}</td>
                    <td>
                        {% if asset.status_assetloan %}
                        {% if asset.current_loan %}
                        {% if asset.current_loan.order_asset.status == "pending" %}
                        <button class="btn btn-sm btn-warning" disabled>ถูกยืมอยู่ (รออนุมัติการยืม..)</button>
                        {% elif asset.current_loan.order_asset.status == "approved" or asset.current_loan.order_asset.status == "borrowed" %}
                        <button class="btn btn-sm btn-secondary" disabled>กำลังยืมอยู่</button>
                        {% elif asset.current_loan.order_asset.status == "returned_pending" %}
                        <button class="btn btn-sm btn-warning" disabled>รออนุมัติการคืน..</button>
                        {% elif asset.current_loan.order_asset.status == "overdue" %}
                        <button class="btn btn-sm btn-danger" disabled>ยืมเกินกำหนด.. กรุณาส่งคืน</button>
                        {% endif %}
                        {% else %}
                        <button class="btn btn-sm btn-secondary" disabled>ถูกยืมอยู่</button>
                        {% endif %}
                        <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#reserveModal"
                            data-asset-id="{{ asset.pk }}">จอง</button>

                        {% if asset.current_loan %}
                        <div class="mt-2 text-primary small">
                            <strong>ผู้ยืม:</strong> {{ asset.current_loan.order_asset.user.get_full_name }}<br>
                            <strong>วันที่ใช้งาน:</strong> {{ asset.current_loan.order_asset.date_of_use|date:"d M Y, H:i น." }}<br>
                            <strong>กำหนดคืน:</strong> {{ asset.current_loan.order_asset.date_due|date:"d M Y, H:i น." }}
                        </div>
                        {% endif %}

                        {# วนลูปแสดงข้อมูลการจอง #}
                        {% for reservation in asset.current_reservation %}
                        <div class="mt-2 text-warning small">
                            <strong>จองโดย:</strong> {{ reservation.user.get_full_name }}<br>
                            <strong>วันที่:</strong> {{ reservation.reserved_date|date:"d M Y, H:i น." }} ถึง {{ reservation.returning_date|date:"d M Y, H:i น." }}
                        </div>
                        {% endfor %}
                        {% else %}
                        <button class="btn btn-sm btn-success add-to-cart">เพิ่มในตะกร้า</button>
                        {% endif %}

                    </td>
                    {% if request.user.is_admin or request.user.is_warehouse_manager %}
                    <td>
                        <div class="btn-group d-flex justify-content-center" role="group">
                            <a href="{% url 'assets:edit_asset_item_loan' asset.pk %}" class="btn btn-sm btn-warning"
                                title="แก้ไข"><i class="bi bi-pencil"></i></a>
                            <button type="button" class="btn btn-sm btn-danger" title="ลบ" data-bs-toggle="modal"
                                data-bs-target="#deleteModal" data-asset-name="{{ asset.item_name }}"
                                data-delete-url="{% url 'assets:delete_asset_item_loan' asset.pk %}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">ไม่พบข้อมูล</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="helpModalLabel"><i class="bi bi-question-circle"></i> วิธีใช้งานระบบยืม-จองครุภัณฑ์</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4>การยืมครุภัณฑ์ (สถานะ "ว่าง")</h4>
                <ol>
                    <li>เลือกครุภัณฑ์ที่ต้องการยืมที่มีปุ่ม **<kbd class="bg-success">เพิ่มในตะกร้า</kbd>**</li>
                    <li>กดปุ่ม **<kbd class="bg-success">เพิ่มในตะกร้า</kbd>** ครุภัณฑ์จะถูกเพิ่มไปยังตะกร้า</li>
                    <li>กดที่ไอคอน **<i class="bi bi-cart3"></i> ตะกร้า** เพื่อไปยังหน้ารายการยืม</li>
                    <li>กรอกรายละเอียดการยืม **วัน-เวลาที่ต้องการยืม** และ **วัน-เวลาที่ต้องการคืน** ส่งคำขอ</li>
                    <li>รอผู้ดูแลอนุมัติ (หากผูกบัญชี LINE Notify ไว้ จะได้รับการแจ้งเตือน)</li>
                </ol>
                <hr>
                <h4>การจองครุภัณฑ์ (สถานะ "ถูกยืมอยู่" หรือ "กำลังยืมอยู่")</h4>
                <p>กรณีที่ครุภัณฑ์ถูกยืมไปแล้ว คุณสามารถทำการจองเพื่อใช้งานต่อจากผู้ใช้คนปัจจุบันได้</p>
                <ol>
                    <li>เลือกครุภัณฑ์ที่ถูกยืมอยู่ ซึ่งมีปุ่ม **<kbd class="bg-info">จอง</kbd>**</li>
                    <li>กดปุ่ม **<kbd class="bg-info">จอง</kbd>** เพื่อเปิดหน้าต่าง Modal สำหรับกรอกรายละเอียดการจอง</li>
                    <li>ระบุ **วัน-เวลาที่ต้องการยืม** และ **วัน-เวลาที่ต้องการคืน** (ต้องเป็นช่วงเวลาหลังจากที่ผู้ยืมคนปัจจุบันกำหนดคืนแล้ว)</li>
                    <li>กดยืนยันการจอง</li>
                    <li>รอผู้ดูแลอนุมัติคำขอจอง</li>
                    <li>เมื่อการจองได้รับการอนุมัติ และผู้ยืมคนปัจจุบันส่งคืนครุภัณฑ์แล้ว สถานะของครุภัณฑ์จะเปลี่ยนเป็น **รอผู้จองมารับ**</li>
                </ol>
                <hr>
                <h4>สถานะการทำงาน</h4>
                <ul class="list-unstyled">
                    <li><span class="badge bg-success">ว่าง หรือ เพิ่มในตะกร้า</span>: สามารถเพิ่มในตะกร้าเพื่อทำการยืมได้</li>
                    <li><span class="badge bg-secondary">กำลังยืมอยู่</span>: ถูกยืมและได้รับอนุมัติแล้ว หรืออยู่ระหว่างการใช้งาน</li>
                    <li><span class="badge bg-warning">ถูกยืมอยู่ (รออนุมัติการยืม..)</span>: อยู่ระหว่างรอผู้ดูแลอนุมัติคำขอยืม</li>
                    <li><span class="badge bg-warning">รออนุมัติการคืน..</span>: ผู้ยืมแจ้งคืนแล้ว อยู่ระหว่างรอผู้ดูแลตรวจสอบและรับคืน</li>
                    <li><span class="badge bg-danger">ยืมเกินกำหนด.. กรุณาส่งคืน</span>: ยืมเกินวันที่กำหนดคืนแล้ว</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="lineNotifyModal" tabindex="-1" aria-labelledby="lineNotifyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="lineNotifyModalLabel"><i class="bi bi-bell-fill"></i> กรุณาผูกบัญชี LINE
                    เพื่อรับการแจ้งเตือน</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="lead">
                    เพื่อไม่พลาดทุกการแจ้งเตือนสถานะการยืมครุภัณฑ์<br>
                    <strong>กรุณาแอดไลน์และผูกบัญชีเพื่อรับการแจ้งเตือน</strong>
                </p>

                {# เปลี่ยน 'images/line_qrcode.png' เป็นตำแหน่งไฟล์จริงของคุณ #}
                <img src="{% static 'app_general/line_qrcode_asset.png' %}" alt="LINE QR Code"
                    class="img-fluid mb-3 border p-2" style="max-width: 200px;">

                <div class="alert alert-info text-start small">
                    <p class="mb-1"><strong>วิธีผูกบัญชี:</strong></p>
                    <ol class="mb-0">
                        <li>สแกนคิวอาร์โค้ด หรือเพิ่มเพื่อน LINE Bot</li>
                        <li>พิมพ์คำว่าผูกบัญชี ตามด้วยรหัสส่วนตัวของคุณ</li>
                    </ol>
                    <p class="mt-2 mb-0 fw-bold">ตัวอย่าง: <kbd>ผูกบัญชี ad......</kbd></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">รับทราบ</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">ยืนยันการลบข้อมูล</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                คุณต้องการลบรายการครุภัณฑ์ "<strong id="asset-name"></strong>" ใช่หรือไม่?
                การกระทำนี้ไม่สามารถย้อนกลับได้
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <form id="deleteForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">ยืนยันการลบ</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reserveModal" tabindex="-1" aria-labelledby="reserveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reserveModalLabel">จองครุภัณฑ์: <span id="asset-name-reserve"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="reserveForm" method="post" action="">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="asset_id" id="reserve-asset-id">

                    <div class="mb-3">
                        <label for="id_reserved_date" class="form-label">วันที่ต้องการยืม</label>
                        <input type="datetime-local" class="form-control" id="id_reserved_date" name="reserved_date"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="id_returning_date" class="form-label">วันที่ต้องการคืน</label>
                        <input type="datetime-local" class="form-control" id="id_returning_date" name="returning_date"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="id_notes" class="form-label">หมายเหตุ</label>
                        <textarea class="form-control" id="id_notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary" onclick="this.disabled=true; this.innerHTML='กำลังประมวลผล'; this.form.submit();">ยืนยันการจอง</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // **********************************
    // โค้ดสำหรับแสดง LINE Notify Modal เมื่อโหลดหน้า (แสดงทุกครั้งและปิดอัตโนมัติ)
    // **********************************
    //   document.addEventListener('DOMContentLoaded', (event) => {
    //       const lineNotifyModalElement = document.getElementById('lineNotifyModal');
    //       const lineNotifyModal = new bootstrap.Modal(lineNotifyModalElement);

    // 1. แสดง Modal ทันที
    //       lineNotifyModal.show();

    // 2. ตั้งเวลาให้ Modal ปิดตัวเองหลังจาก 10 วินาที (10000 มิลลิวินาที)
    //       setTimeout(() => {
    //           lineNotifyModal.hide();
    //       }, 10000); // 10 วินาที
    //    });

    // **********************************
    // โค้ดสำหรับแสดง LINE Notify Modal เมื่อโหลดหน้า (เช็คสถานะการผูกบัญชี)
    // **********************************
    
    // ดึงค่าสถานะการผูกบัญชี LINE จาก Django context
    // ใช้ 'false' เป็นค่า default เผื่อกรณีที่ request.user.is_anonymous หรือไม่ได้ส่งค่ามา
    const hasLineAccount = {{ has_line_account|yesno:"true,false" }}; 

    document.addEventListener('DOMContentLoaded', (event) => {
        // เช็คว่าผู้ใช้ล็อกอินอยู่และยังไม่ได้ผูกบัญชี LINE
        // request.user.is_authenticated จะเป็นจริงเสมอในหน้านี้ถ้าใช้ @login_required 
        // แต่การเช็ค '{{ request.user.is_authenticated }}' ใน template อาจมีความซับซ้อน 
        // เราจะเน้นไปที่การเช็ค 'hasLineAccount' ที่มาจาก view แล้ว
        
        if ({{ request.user.is_authenticated|lower }} === true && hasLineAccount === false) {
            const lineNotifyModalElement = document.getElementById('lineNotifyModal');
            const lineNotifyModal = new bootstrap.Modal(lineNotifyModalElement);
            
            // 1. แสดง Modal ทันที
            lineNotifyModal.show();
            
            // 2. ตั้งเวลาให้ Modal ปิดตัวเองหลังจาก 10 วินาที (10000 มิลลิวินาที)
            setTimeout(() => {
                lineNotifyModal.hide();
            }, 10000); // 10 วินาที
        }
    });


    // **********************************
    // โค้ดสำหรับตะกร้าและ Modal ลบ (โค้ดรวม) - เหมือนเดิม
    // **********************************
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const cartBadge = document.getElementById('cart-badge');

    function updateCartUI() {
        cartBadge.textContent = cart.length;
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            const tr = btn.closest('tr');
            const assetId = parseInt(tr.dataset.id);
            if (cart.includes(assetId)) {
                btn.textContent = 'เพิ่มแล้ว';
                btn.disabled = true;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
            } else {
                btn.textContent = 'เพิ่มในตะกร้า';
                btn.disabled = false;
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-success');
            }
        });
    }

    document.querySelectorAll('.add-to-cart').forEach(btn => {
        btn.addEventListener('click', function () {
            const tr = this.closest('tr');
            const assetId = parseInt(tr.dataset.id);
            if (!cart.includes(assetId)) {
                cart.push(assetId);
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartUI();
            }
        });
    });

    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const deleteUrl = button.getAttribute('data-delete-url');
            const assetName = button.getAttribute('data-asset-name');
            const deleteForm = deleteModal.querySelector('#deleteForm');
            const assetNamePlaceholder = deleteModal.querySelector('#asset-name');
            deleteForm.action = deleteUrl;
            assetNamePlaceholder.textContent = assetName;
        });
    }
    updateCartUI();

    // โค้ดสำหรับ Modal จอง - เหมือนเดิม
    const reserveModal = document.getElementById('reserveModal');
    if (reserveModal) {
        reserveModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const assetId = button.getAttribute('data-asset-id');
            const assetName = button.closest('tr').querySelector('td:nth-child(2)').textContent;

            const reserveForm = reserveModal.querySelector('#reserveForm');
            const assetNamePlaceholder = reserveModal.querySelector('#asset-name-reserve');
            const assetIdInput = reserveModal.querySelector('#reserve-asset-id');

            reserveForm.action = `{% url 'assets:reserve_asset_item' 0 %}`.replace('0', assetId);
            assetNamePlaceholder.textContent = assetName;
            assetIdInput.value = assetId;
        });
    }
</script>
{% endblock %}