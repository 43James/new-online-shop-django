{% extends "base_sidebar.html" %}
{% load static %}
{% block content %}

<style>
  @font-face {
    font-family: 'TH Sarabun New';
    src: url('https://db.s-cdn.co/fonts/thsarabunnew-webfont.woff2') format('woff2'),
         url('https://db.s-cdn.co/fonts/thsarabunnew-webfont.woff') format('woff');
    font-weight: normal;
    font-style: normal;
  }
  @font-face {
    font-family: 'TH Sarabun New';
    src: url('https://db.s-cdn.co/fonts/thsarabunnew-bold-webfont.woff2') format('woff2'),
         url('https://db.s-cdn.co/fonts/thsarabunnew-bold-webfont.woff') format('woff');
    font-weight: bold;
    font-style: normal;
  }
  
  .container.mt-4 {
    font-family: 'TH Sarabun New', sans-serif;
    font-size: 20px;
  }
</style>

<div class="container mt-4">
    <div id="print-area" class="card p-4 shadow-sm">
        <div class="row mb-4 align-items-center">
            <div class="col-3">
                <img src="{% static 'app_general/logo.png' %}" alt="Logo" class="img-fluid" style="max-height: 80px;">
            </div>
            <div class="col-6 text-center">
                <h4 class="fw-bold mb-0">ใบขอยืมอุปกรณ์</h4>
                <p class="mb-0">อุทยานวิทยาศาสตร์ มหาวิทยาลัยอุบลราชธานี</p>
                <p class="mb-0">(Ubon Ratchathani University Science Park)</p>
            </div>
            <div class="col-3 text-end">
                <p class="mb-0">หมายเลขเอกสาร SP-SPO {{ loan.id }}</p>
            </div>
        </div>

        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-6">
                    <div class="form-control-plaintext border-bottom"><strong>ชื่อ-สกุล</strong> {{ loan.user.first_name }} {{ loan.user.last_name }}</div>
                </div>
                <div class="col-md-6">
                    <div class="form-control-plaintext border-bottom"><strong>ที่ทำงาน</strong> โครงการอุทยานวิทยาศาสตร์</div>
                </div>
                <div class="col-12">
                    <div class="form-control-plaintext border-bottom"><strong>ตำแหน่ง</strong> {{ loan.user.profile.position }}  &nbsp;&nbsp;&nbsp; <strong>Email</strong>  {{ loan.user.email }}  &nbsp;&nbsp;&nbsp;&nbsp; <strong>โทรศัพท์มือถือ</strong>  {{ loan.user.profile.phone }}</div>
                </div>
            </div>
        </div>
        
        <p class="mt-3">ความประสงค์จะขอยืมอุปกรณ์รายการดังต่อไปนี้</p>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th class="text-center" style="width: 5%;">ลำดับ</th>
                        <th>รายการ</th>
                        <th class="text-center" style="width: 15%;">จำนวน</th>
                        <th style="width: 30%;">หมายเหตุ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in loan.items.all %}
                    <tr>
                        <td class="text-center">{{ forloop.counter }}</td>
                        <td>{{ item.asset.item_name }} ({{ item.asset.asset_code }})</td>
                        <td class="text-center">1 {{ item.asset.unit }}</td>
                        <td>{{ item.asset.notes }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">ไม่มีรายการครุภัณฑ์ในใบยืมนี้</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <p class="fw-bold">ต้องการสิ่งของในวันที่:</p>
                <p class="border-bottom p-2">{{ loan.date_of_use|date:"d M Y"|default:"-" }}</p>
            </div>
            <div class="col-md-6">
                <p class="fw-bold">จะส่งคืนในวันที่:</p>
                <p class="border-bottom p-2">{{ loan.date_due|date:"d M Y"|default:"-" }}</p>
            </div>
        </div>

        <p class="text-muted">
               &nbsp;&nbsp;&nbsp;&nbsp;
               ในการขอใช้ครั้งนี้ หากสิ่งของที่นำมาส่งคืนเกิดชำรุดเสียหาย หรือใช้การไม่ได้ หรือสูญหาย ข้าพเจ้ายินดีจัดการแก้ไขให้คงสภาพเดิม โดยเสียค่าใช้จ่ายของตนเอง หรือชดใช้เป็นเงินพัสดุ หรือครุภัณฑ์ ประเภท ชนิด ขนาด ลักษณะและคุณภาพอย่างเดียวกัน หรือชดใช้เป็นเงินตามรายการสิ่งของที่เป็นอยู่
        </p>
        <div class="row">
            {% comment %} <div></div> {% endcomment %}
            <div class="row justify-content-end text-center mt-3">
                <div class="col-md-4">
                    <p class="mb-2 ">ลงชื่อ ____ {{ loan.user.first_name }} ____ผู้ยืม</p>
                    <p class="mb-1">( {{ loan.user.get_full_name }} )</p>
                    <p>วันที่ {{ loan.date_created|date:"d M Y" }}</p>
                </div>
            </div>
        </div>
        <hr>
        {% if loan.status == 'approved' or loan.status == 'cancel' or loan.status == 'rejected' %}
        <div class="row">
            <div class="col-md-6 border-end">
                {% comment %} <h5 class="">บันทึกการยืม</h5> {% endcomment %}
                <p class="fw-bold">บันทึกการยืม (สำหรับเจ้าหน้าที่)</p>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" {% if loan.status == 'approved' or loan.status == 'borrowed' or loan.status == 'returned' or loan.status == 'overdue' or loan.status == 'returned_pending' %}checked{% endif %} disabled>
                        <label class="form-check-label">สามารถให้ยืมได้</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" {% if loan.status == 'rejected' %}checked{% endif %} disabled>
                        <label class="form-check-label">ไม่สามารถให้ยืมได้ เนื่องจาก ___ {{ loan.note }} ___<span class="border-bottom"></span></label>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <p class="mb-3">ลงชื่อ ____ {{ loan.get_approver_first_name|default:"-" }} _____</p>
                    <p class="mb-1">( {{ loan.approved_by|default:"-" }} )</p>
                    <p class="mb-1">ตำแหน่ง {{ loan.approver_position|default:"-" }}</p>
                    <p>วันที่ {{ loan.date_approved|date:"d M Y"|default:"-" }}</p>
                </div>
            </div>

            <div class="col-md-6">
                {% comment %} <h5 class="">บันทึกการยืม</h5> {% endcomment %}
                <p class="fw-bold">บันทึกการยืม (สำหรับผู้ยืม)</p>
                <p class="text-center">ข้าพเจ้าได้รับของตามรายการข้างต้นแล้ว</p>
                <div class="text-center mt-5">
                    <p class="mb-3">ลงชื่อ ____ {{ loan.user.first_name|default:"-" }} _____</p>
                    <p class="mb-1">( {{ loan.user.get_full_name }} )</p>
                    <p class="mb-1">ตำแหน่ง {{ loan.user.profile.position|default:"-" }}</p>
                    <p>วันที่ {{ loan.date_approved|date:"d M Y"|default:"-" }}</p>
                </div>
            </div>
        </div>

        {% elif loan.status == 'approved' or loan.status == 'borrowed' or loan.status == 'returned' or loan.status == 'overdue' or loan.status == 'returned_pending' %}
        <div class="row">
            <div class="col-md-6 border-end">
                {% comment %} <h5 class="">บันทึกการยืม</h5> {% endcomment %}
                <p class="fw-bold">บันทึกการยืม (สำหรับเจ้าหน้าที่)</p>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" {% if loan.status == 'approved' or loan.status == 'borrowed' or loan.status == 'returned' or loan.status == 'overdue' or loan.status == 'returned_pending' %}checked{% endif %} disabled>
                        <label class="form-check-label">สามารถให้ยืมได้</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" {% if loan.status == 'rejected' %}checked{% endif %} disabled>
                        <label class="form-check-label">ไม่สามารถให้ยืมได้ เนื่องจาก ___ {{ loan.note }} ___<span class="border-bottom"></span></label>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <p class="mb-3">ลงชื่อ ____ {{ loan.get_approver_first_name|default:"-" }} _____</p>
                    <p class="mb-1">( {{ loan.approved_by|default:"-" }} )</p>
                    <p class="mb-1">ตำแหน่ง {{ loan.approver_position|default:"-" }}</p>
                    <p>วันที่ {{ loan.date_approved|date:"d M Y"|default:"-" }}</p>
                </div>
            </div>

            <div class="col-md-6">
                {% comment %} <h5 class="">บันทึกการยืม</h5> {% endcomment %}
                <p class="fw-bold">บันทึกการยืม (สำหรับผู้ยืม)</p>
                <p class="text-center">ข้าพเจ้าได้รับของตามรายการข้างต้นแล้ว</p>
                <div class="text-center mt-5">
                    <p class="mb-3">ลงชื่อ ____ {{ loan.user.first_name|default:"-" }} _____</p>
                    <p class="mb-1">( {{ loan.user.get_full_name }} )</p>
                    <p class="mb-1">ตำแหน่ง {{ loan.user.profile.position|default:"-" }}</p>
                    <p>วันที่ {{ loan.date_approved|date:"d M Y"|default:"-" }}</p>
                </div>
            </div>
        </div>
        <hr>
        <div class="row ">
            <div class="col-md-6 border-end">
                {% comment %} <h5 class="">บันทึกการส่งคืน</h5> {% endcomment %}
                <div class="mb-3">
                    <p class="fw-bold">บันทึกส่งคืน (สำหรับผู้ยืม)</p>
                    <p>ขอส่งสิ่งของคืนจำนวน {{ loan.get_total_assets }} รายการ</p>
                </div>
                <div class="text-center mt-5">
                    <p class="mb-3">ลงชื่อ ____ {{ loan.get_returned_by_first_name|default:"-" }} _____</p>
                    <p class="mb-1">( {{ loan.returned_by|default:"-" }} )</p>
                    <p class="mb-1">ตำแหน่ง {{ loan.user.profile.position|default:"-" }}</p>
                    <p>วันที่ {{ loan.date_returned|date:"d M Y"|default:"-" }}</p>
                </div>
            </div>

            <div class="col-md-6">
                {% comment %} <h5 class="">บันทึกการส่งคืน</h5> {% endcomment %}
                <p class="fw-bold">บันทึกผลการใช้งาน (สำหรับเจ้าหน้าที่)</p>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" {% if loan.status_return == 'not_damaged' %}checked{% endif %} disabled>
                        <label class="form-check-label">ไม่มีการการชำรุด</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" {% if loan.status_return == 'damaged' %}checked{% endif %} disabled>
                        <label class="form-check-label">ชำรุด คือ ___ {{ loan.receiver_note }} ___ <span class="border-bottom"></span></label>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <p class="mb-3">ลงชื่อ ____ {{ loan.get_received_by_first_name|default:"-" }} _____</p>
                    <p class="mb-1">( {{ loan.received_by|default:"-" }} )</p>
                    <p class="mb-1">ตำแหน่ง {{ loan.receiver_position|default:"-" }}</p>
                    <p>วันที่ {{ loan.date_received|date:"d M Y"|default:"-" }}</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
<div class="text-center mt-4 mb-4 d-print-none">
        <button class="btn btn-primary" onclick="printContent('print-area')">
            <i class="bi bi-printer-fill"></i> พิมพ์ใบยืม
        </button>
        <a onclick="history.back()"class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> กลับ
        </a>
    </div>


<script>
function printContent(elementId) {
    var printContents = document.getElementById(elementId).innerHTML;
    var printWindow = window.open('', '_blank', 'height=600,width=800');

    printWindow.document.open();
    printWindow.document.write('<!DOCTYPE html>');
    printWindow.document.write('<html>');
    printWindow.document.write('<head>');
    printWindow.document.write('<title>ใบขอยืมอุปกรณ์</title>');
    
    // โหลด Bootstrap CSS จาก CDN
    printWindow.document.write('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">');
    
    // โหลด Bootstrap Icons จาก CDN
    printWindow.document.write('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">');

    // โหลด Font Sarabun จาก Google Fonts
    printWindow.document.write('<link rel="preconnect" href="https://fonts.googleapis.com">');
    printWindow.document.write('<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>');
    printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">');
    
    // CSS สำหรับการพิมพ์โดยเฉพาะ
    printWindow.document.write('<style>');
    printWindow.document.write('body { margin: 0; padding: 0; font-family: "TH Sarabun New", "Sarabun", sans-serif !important; font-size: 16pt; }');
    printWindow.document.write('.container { width: 100% !important; max-width: none !important; margin: 0; padding: 0 !important; }');
    printWindow.document.write('.card { border: none !important; box-shadow: none !important; padding: 15px !important; }');
    printWindow.document.write('table { width: 100% !important; border-collapse: collapse; }');
    printWindow.document.write('th, td { border: 1px solid #000 !important; padding: 0.3rem !important; }');
    printWindow.document.write('.table-light th { background-color: #f8f9fa !important; -webkit-print-color-adjust: exact; }');
    printWindow.document.write('.row.mb-4.align-items-center { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem !important; }');
    printWindow.document.write('.row.mb-4.align-items-center .col-3 { width: 25%; flex: none; text-align: left; }');
    printWindow.document.write('.row.mb-4.align-items-center .col-6 { width: 50%; flex: none; text-align: center; }');
    printWindow.document.write('.row.mb-4.align-items-center .col-3.text-end { width: 25%; flex: none; text-align: right; }');
    printWindow.document.write('.row.mb-4.align-items-center h4, .row.mb-4.align-items-center p { margin-bottom: 0.2rem !important; line-height: 1.2; }');
    printWindow.document.write('.mb-3 .row.g-2 { display: flex; flex-wrap: wrap; margin-left: -0.5rem; margin-right: -0.5rem; }');
    printWindow.document.write('.mb-3 .row.g-2 > div { padding-left: 0.5rem; padding-right: 0.5rem; margin-bottom: 0.5rem; }');
    printWindow.document.write('.mb-3 .col-md-6 { width: 50%; flex: none; }');
    printWindow.document.write('.mb-3 .col-12 { width: 100%; flex: none; }');
    printWindow.document.write('.form-control-plaintext { border-bottom: 1px solid #000 !important; padding-bottom: 0.2rem !important; margin-bottom: 0.5rem !important; line-height: 1.2; }');
    printWindow.document.write('.row.mt-3 { display: flex; justify-content: space-between; margin-top: 1rem !important; }');
    printWindow.document.write('.row.mt-3 .col-md-6 { width: 50%; flex: none; }');
    printWindow.document.write('.row.mt-3 .border-bottom.p-2 { border-bottom: 1px solid #000 !important; padding: 0.2rem 0 !important; display: block; }');
    printWindow.document.write('.fw-bold { font-weight: bold !important; }');
    printWindow.document.write('p.text-muted { text-indent: 40px; !important; font-size: 14pt; }'); // ปรับขนาดฟอนต์และย่อหน้า
    printWindow.document.write('.row.justify-content-end.text-center.mt-3 { text-align: right !important; margin-top: 1rem !important; display: block; width: 100%; }');
    printWindow.document.write('.row.justify-content-end.text-center.mt-3 .col-md-4 { width: 33.33%; float: right; }');
    printWindow.document.write('.row.justify-content-end.text-center.mt-3 p { margin-bottom: 0.2rem !important; line-height: 1.2; }');
    printWindow.document.write('.row { display: flex; flex-wrap: wrap; clear: both; page-break-inside: avoid; margin-top: 2rem !important; }');
    printWindow.document.write('.row > .col-md-6 { width: 50%; flex: none; float: left; padding-right: 15px; box-sizing: border-box; }');
    printWindow.document.write('.row > .col-md-6.border-end { border-right: 1px solid #000 !important; }');
    printWindow.document.write('p.fw-bold { margin-bottom: 0.5rem !important; }');
    printWindow.document.write('.form-check { margin-bottom: 0.5rem !important; }');
    printWindow.document.write('.form-check-input { margin-right: 0.5rem !important; }');
    printWindow.document.write('.form-check-label { display: inline; }');
    printWindow.document.write('.text-center.mt-2, .text-center.mt-5 { text-align: center !important; margin-top: 1rem !important; display: block; width: 100%; }');
    printWindow.document.write('.text-center.mt-2 p, .text-center.mt-5 p { margin-bottom: 0.2rem !important; line-height: 1.2; }');
    printWindow.document.write('hr { border: 0.5px solid #000 !important; margin-top: 1.5rem !important; margin-bottom: 1.5rem !important; -webkit-print-color-adjust: exact; }');
    printWindow.document.write('.d-print-none { display: none !important; }');
    printWindow.document.write('</style>');

    printWindow.document.write('</head>');
    printWindow.document.write('<body>');
    printWindow.document.write(printContents);
    printWindow.document.write('</body>');
    printWindow.document.write('</html>');
    printWindow.document.close();

    printWindow.onload = function() {
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    };
}
</script>

{% endblock %}

<div class="col-md-6 border-end">
                <h5 class="mb-3">บันทึกการส่งคืน</h5>
                <div class="mb-3">
                    <p class="fw-bold">[สำหรับเจ้าหน้าที่]</p>
                    <p>ได้รับสิ่งของคืนครบถ้วน</p>
                    <p class="border-bottom p-2">{{ loan.receiver_note|default:"-" }}</p>
                </div>
                <div class="text-center mt-5">
                    <p class="mb-4">ลงชื่อ.........................................</p>
                    <p class="mb-1">( {{ loan.received_by|default:"-" }} )</p>
                    <p class="mb-1">ตำแหน่ง {{ loan.receiver_position|default:"-" }}</p>
                    <p>วันที่ {{ loan.date_received|date:"d M Y"|default:"-" }}</p>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="mb-3">บันทึกสถานะการใช้งาน</h5>
                <p class="fw-bold">รายละเอียดการใช้งาน</p>
                <p class="border-bottom p-2">{{ loan.note|default:"-" }}</p>
                <div class="text-center mt-5">
                    <p class="mb-4">ลงชื่อ.........................................</p>
                    <p class="mb-1">( {{ loan.returned_by|default:"-" }} )</p>
                    <p class="mb-1">ตำแหน่ง {{ loan.user.profile.position|default:"-" }}</p>
                    <p>วันที่ {{ loan.date_returned|date:"d M Y"|default:"-" }}</p>
                </div>
            </div>