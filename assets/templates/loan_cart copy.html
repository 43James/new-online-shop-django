{% extends "base_sidebar.html" %}
{% load static %}

{% block content %}
<div class="container col-4 mt-4">
    <h3>ตะกร้าครุภัณฑ์</h3>
    <hr>

    <div class="card mb-4">
        <div class="card-body">
            <ul id="cart-list" class="list-group list-group-flush">
                <!-- รายการครุภัณฑ์ในตะกร้าจะถูกโหลดด้วย JS -->
            </ul>
            <hr>
            <h5>รวม <span id="cart-count">0</span> รายการ</h5>
        </div>
    </div>

    <div class="card" id="checkout-card" style="display:none;">
        <div class="card-body">
            <h5 class="card-title">ยืนยันการยืม</h5>
            <form id="checkout-form" action="{% url 'assets:confirm_loan' %}" method="post">
                {% csrf_token %}
                <div class="mb-3 col-5">
                    <label for="date_of_use" class="form-label">วันที่ใช้งาน</label>
                    <input type="datetime-local" name="date_of_use" class="form-control" required>
                </div>
                <div class="mb-3 col-5">
                    <label for="date_due" class="form-label">วันที่กำหนดคืน</label>
                    <input type="datetime-local" name="date_due" class="form-control" required>
                </div>
                <!-- ส่งค่า id ของครุภัณฑ์ทั้งหมดในตะกร้า -->
                <input type="hidden" name="asset_ids" id="asset-ids">
                <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#confirmLoanModal">ยืมครุภัณฑ์</button>
                <!-- <button type="submit" class="btn btn-primary w-100" onclick="this.disabled=true; this.innerHTML='กำลังประมวลผล'; this.form.submit();">ยืมครุภัณฑ์</button> -->
            </form>
        </div>
    </div>

    <div class="mt-4">
        <a href="{% url 'assets:loan_list' %}" class="btn btn-outline-secondary">กลับไปที่รายการครุภัณฑ์</a>
    </div>
</div>

<div class="modal fade" id="confirmLoanModal" tabindex="-1" aria-labelledby="confirmLoanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="confirmLoanModalLabel"><i class="bi bi-shield-fill-check"></i> ยืนยันคำขอการยืมครุภัณฑ์</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>คุณแน่ใจหรือไม่ที่จะส่งคำขอการยืมครุภัณฑ์ตามรายการและรายละเอียดดังต่อไปนี้?</strong></p>
                
                <p>จำนวนครุภัณฑ์: <strong id="modal-item-count">0</strong> รายการ</p>
                <p>วันที่ใช้งาน: <strong id="modal-date-use"></strong></p>
                <p>วันที่กำหนดคืน: <strong id="modal-date-due"></strong></p>

                <div class="alert alert-warning small mt-3" role="alert">
                    เมื่อกดยืนยันแล้ว คำขอจะถูกส่งไปยังผู้ดูแลเพื่อพิจารณา
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary" id="confirm-submit-btn" onclick="this.disabled=true; this.innerHTML='กำลังบันทึกข้อมูล...'; this.form.submit();">ยืนยันการยืม</button>
            </div>
        </div>
    </div>
</div>

<script>
// ✅ โหลดตะกร้าจาก localStorage
let cart = JSON.parse(localStorage.getItem('cart') || '[]');

// ✅ ข้อมูลครุภัณฑ์ทั้งหมด (ต้องส่งมาจาก view)
const assetItems = [
    {% for asset in asset_items %}
    {
        id: {{ asset.id }},
        name: "{{ asset.item_name|escapejs }}",
        code: "{{ asset.asset_code }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// เตรียม DOM Elements ที่ใช้บ่อย
const list = document.getElementById('cart-list');
const count = document.getElementById('cart-count');
const checkoutCard = document.getElementById('checkout-card');
const hiddenInput = document.getElementById('asset-ids');
const confirmLoanModal = document.getElementById('confirmLoanModal');
const confirmSubmitBtn = document.getElementById('confirm-submit-btn');
const checkoutForm = document.getElementById('checkout-form');


function renderCart(){
    list.innerHTML = '';
    let itemsInCart = assetItems.filter(a => cart.includes(a.id));

    if(itemsInCart.length === 0){
        list.innerHTML = `<li class="list-group-item text-muted text-center">ไม่มีครุภัณฑ์ในตะกร้า</li>`;
        count.textContent = 0;
        checkoutCard.style.display = "none";
        hiddenInput.value = '';
        return;
    }

    itemsInCart.forEach(asset => {
        let li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `${asset.name} (${asset.code})
            <button class="btn btn-sm btn-danger remove-item" data-id="${asset.id}">ลบ</button>`;
        list.appendChild(li);
    });

    // สำคัญ: อัปเดตค่าใน DOM
    count.textContent = itemsInCart.length;
    checkoutCard.style.display = "block";
    hiddenInput.value = cart.join(",");
}

// ✅ ลบจากตะกร้า
document.addEventListener('click', function(e){
    if(e.target.classList.contains('remove-item')){
        const id = parseInt(e.target.dataset.id);
        cart = cart.filter(i => i !== id);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
    }
});

// **************************************************
// START: โค้ดสำหรับ Modal ยืนยัน (ปรับปรุง)
// **************************************************

// แปลงวันที่/เวลา ให้อ่านง่าย
function formatDateTime(datetimeLocal) {
    if (!datetimeLocal) return "—";
    const date = new Date(datetimeLocal);
    return date.toLocaleDateString('th-TH', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
    }) + ' น.';
}

// 1. เมื่อ Modal จะแสดง (เพื่อดึงข้อมูลจาก Form มาแสดงใน Modal)
confirmLoanModal.addEventListener('show.bs.modal', function (event) {
    
    // ต้องตรวจสอบ Form Validation ก่อนแสดง Modal
    if (!checkoutForm.checkValidity()) {
        event.preventDefault(); // ป้องกัน Modal เปิด
        event.stopPropagation();
        checkoutForm.classList.add('was-validated'); // แสดงข้อความ error
        return;
    }

    // รีเซ็ตปุ่มก่อนแสดง Modal 
    confirmSubmitBtn.disabled = false;
    confirmSubmitBtn.innerHTML = 'ยืนยันการยืม';

    // ดึงค่าจาก DOM ที่อัปเดตแล้ว
    const dateOfUse = document.getElementById('date_of_use').value;
    const dateDue = document.getElementById('date_due').value;
    
    // *** การแก้ไขปัญหา: ดึงค่าจาก element ที่ถูกอัปเดตใน renderCart() แล้ว ***
    const itemCount = document.getElementById('cart-count').textContent; 

    document.getElementById('modal-item-count').textContent = itemCount;
    document.getElementById('modal-date-use').textContent = formatDateTime(dateOfUse);
    document.getElementById('modal-date-due').textContent = formatDateTime(dateDue);
});

// 2. เมื่อกดปุ่ม "ยืนยันการยืม" ใน Modal
confirmSubmitBtn.addEventListener('click', function() {
    // ป้องกันการกดย้ำ และแสดงสถานะ
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังส่งคำขอ...';

    // ปิด Modal (หากต้องการให้ Modal ปิดก่อนส่ง form)
    const modalInstance = bootstrap.Modal.getInstance(confirmLoanModal);
    modalInstance.hide();
    
    // ล้างตะกร้าก่อน Submit
    localStorage.removeItem("cart"); 
    
    // ส่ง Form จริง
    checkoutForm.submit();
});
// **************************************************
// END: โค้ดสำหรับ Modal ยืนยัน
// **************************************************

// ✅ เริ่มต้น render เพื่อโหลดข้อมูลจาก localStorage เมื่อหน้าเว็บโหลด
renderCart();
</script>

<!-- <script>
// ✅ โหลดตะกร้าจาก localStorage
let cart = JSON.parse(localStorage.getItem('cart') || '[]');

// ✅ ข้อมูลครุภัณฑ์ทั้งหมด (ต้องส่งมาจาก view)
const assetItems = [
    {% for asset in asset_items %}
    {
        id: {{ asset.id }},
        name: "{{ asset.item_name|escapejs }}",
        code: "{{ asset.asset_code }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

function renderCart(){
    const list = document.getElementById('cart-list');
    const count = document.getElementById('cart-count');
    const checkoutCard = document.getElementById('checkout-card');
    const hiddenInput = document.getElementById('asset-ids');

    list.innerHTML = '';
    let itemsInCart = assetItems.filter(a => cart.includes(a.id));

    if(itemsInCart.length === 0){
        list.innerHTML = `<li class="list-group-item text-muted text-center">ไม่มีครุภัณฑ์ในตะกร้า</li>`;
        count.textContent = 0;
        checkoutCard.style.display = "none";
        hiddenInput.value = '';
        return;
    }

    itemsInCart.forEach(asset => {
        let li = document.createElement('li');
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `${asset.name} (${asset.code})
            <button class="btn btn-sm btn-danger remove-item" data-id="${asset.id}">ลบ</button>`;
        list.appendChild(li);
    });

    count.textContent = itemsInCart.length;
    checkoutCard.style.display = "block";
    hiddenInput.value = cart.join(",");
}

// ✅ ลบจากตะกร้า
document.addEventListener('click', function(e){
    if(e.target.classList.contains('remove-item')){
        const id = parseInt(e.target.dataset.id);
        cart = cart.filter(i => i !== id);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
    }
});

// ✅ เคลียร์ตะกร้าหลังยืนยันการยืม
document.getElementById("checkout-form").addEventListener("submit", function(){
    localStorage.removeItem("cart");  // ล้างตะกร้า
});

// ✅ เริ่มต้น render
renderCart();
</script> -->
{% endblock %}
