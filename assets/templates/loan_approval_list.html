{% extends "base_sidebar.html" %}
{% load static %}

{% block content %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2 text-primary fw-bold"><i class="bi bi-list-columns-reverse me-2"></i> รายการรออนุมัติการยืม/คืน</h1>
    <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#howToUseModal">
        <i class="bi bi-question-circle"></i> วิธีใช้งานสำหรับเจ้าหน้าที่
    </button>
    </div>

<form method="get" class="row g-3 mb-4 p-3 bg-light rounded shadow-sm align-items-center">
    
    <div class="col-md-4">
        <label for="q" class="form-label visually-hidden">ค้นหา</label>
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" name="q" class="form-control" placeholder="ค้นหาชื่อ, ID ครุภัณฑ์, หรือชื่อผู้ยืม" value="{{ query }}">
        </div>
    </div>

    <div class="col-md-2">
        <label for="month" class="form-label visually-hidden">เดือน</label>
        <select name="month" id="month" class="form-select">
            <option value="">-- เดือนทั้งหมด --</option>
            {% for m in months %}
                <option value="{{ m.0 }}" {% if m.0|stringformat:"s" == selected_month|stringformat:"s" %}selected{% endif %}>{{ m.1 }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <label for="year" class="form-label visually-hidden">ปี</label>
        <select name="year" id="year" class="form-select">
            {% for y in years %}
                <option value="{{ y }}" {% if y|stringformat:"s" == selected_year|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="col-md-2">
        <div class="form-check form-switch pt-2">
            <input type="checkbox" class="form-check-input" id="showRejected" name="show_rejected" {% if show_rejected %}checked{% endif %}>
            <label class="form-check-label" for="showRejected">แสดงรายการที่ปิดแล้ว</label>
        </div>
    </div>

    <div class="col-md-2 d-flex justify-content-end"> 
        <button type="submit" class="btn btn-primary me-2"><i class="bi bi-funnel"></i> กรองข้อมูล</button>
        <a href="{% url 'assets:loan_approval_list' %}" class="btn btn-secondary" title="รีเซ็ตตัวกรอง"><i class="bi bi-arrow-counterclockwise"></i></a>
    </div>
</form>

<div class="card shadow">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 15%;">ผู้ยืม</th>
                        <th style="width: 8%;">ID</th>
                        <th style="width: 15%;">วันที่สร้างรายการ</th>
                        <th style="width: 15%;">วันที่ใช้งาน</th>
                        <th style="width: 15%;">กำหนดคืน</th>
                        <th style="width: 12%;">สถานะ</th>
                        <th style="width: 15%;">การทำงาน</th>
                    </tr>
                </thead>
                <tbody>
                    {% for loan in page_obj %}
                    <tr class="
                        {% if loan.status == 'pending' %}table-warning{% endif %}
                        {% if loan.status == 'returned_pending' %}table-info{% endif %}
                        {% if loan.status == 'overdue' %}table-danger{% endif %}
                    ">
                        <th scope="row">{{ forloop.counter0|add:page_obj.start_index }}</th>
                        <td>{{ loan.user.get_full_name }}</td>
                        <td class="fw-bold">{{ loan.id }}</td>
                        <td>{{ loan.date_created|date:"d/m/Y , H:i น." }}</td>
                        <td>{{ loan.date_of_use|date:"d/m/Y , H:i น." }}</td>
                        <td>{{ loan.date_due|date:"d/m/Y , H:i น." }}</td>
                        <td>
                            {% if loan.status == 'pending' %}
                                <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split"></i> รออนุมัติ</span>
                            {% elif loan.status == 'approved' or loan.status == 'borrowed' %}
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> กำลังยืม</span>
                            {% elif loan.status == 'returned_pending' %}
                                <span class="badge bg-info text-dark"><i class="bi bi-arrow-return-left"></i> รออนุมัติคืน</span>
                            {% elif loan.status == 'returned' %}
                                <span class="badge bg-secondary"><i class="bi bi-check2-all"></i> คืนแล้ว</span>
                            {% elif loan.status == 'rejected' %}
                                <span class="badge bg-danger"><i class="bi bi-slash-circle"></i> ปฏิเสธ</span>
                            {% elif loan.status == 'overdue' %}
                                <span class="badge bg-danger"><i class="bi bi-exclamation-triangle"></i> เกินกำหนด</span>
                            {% elif loan.status == 'cancel' %}
                                <span class="badge bg-danger"><i class="bi bi-x-circle"></i> ผู้ยืมยกเลิก</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if loan.status == 'pending' %}
                                <button class="btn btn-success btn-sm me-1" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#approvalModal" 
                                    data-action="approved" 
                                    data-url="{% url 'assets:loan_approval' loan.id %}"
                                    title="อนุมัติการยืม">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="btn btn-danger btn-sm me-1" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#approvalModal" 
                                    data-action="rejected" 
                                    data-url="{% url 'assets:loan_approval' loan.id %}"
                                    title="ปฏิเสธการยืม">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            {% elif loan.status == 'returned_pending' %}
                                <button class="btn btn-primary btn-sm me-1" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#returnModal"
                                        data-loan-id="{{ loan.id }}" 
                                        data-loan-user="{{ loan.user.get_full_name }}"
                                        title="ตรวจสอบและอนุมัติการคืน">
                                    <i class="bi bi-clipboard-check"></i> คืน
                                </button>
                            {% elif loan.status == 'overdue' %}
                                <form method="POST" 
                                        action="{% url 'assets:loan_notify_overdue' loan.id %}" 
                                        style="display:inline" 
                                        onsubmit="this.querySelector('button').disabled=true; this.querySelector('button').innerHTML='<span class=\'spinner-border spinner-border-sm\'></span>'; return confirm('ยืนยันการส่งแจ้งเตือนเกินกำหนดสำหรับ Order #{{ loan.id }}?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger btn-sm me-1" title="ส่งแจ้งเตือนเกินกำหนด (Line)">
                                        <i class="bi bi-bell-fill"></i>
                                    </button>
                                </form>
                            {% endif %}
                            
                            <a href="{% url 'assets:loan_detail' loan.id %}" class="btn btn-sm btn-info" title="ดูรายละเอียด"><i class="bi bi-eye"></i></a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center p-4 text-muted">
                            <i class="bi bi-folder-open fs-5 me-2"></i> ไม่พบรายการที่ต้องดำเนินการ/ตรวจสอบ
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">ก่อนหน้า</a>
        </li>
        {% endif %}
        <li class="page-item disabled">
            <a class="page-link">หน้า {{ page_obj.number }} จาก {{ page_obj.paginator.num_pages }}</a>
        </li>
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">ถัดไป</a>
        </li>
        {% endif %}
    </ul>
</nav>

<div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" id="returnForm">
            {% csrf_token %}
            <input type="hidden" name="loan_id" id="modalLoanId">
            <input type="hidden" name="status" value="returned">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="returnModalTitle"><i class="bi bi-clipboard-check me-2"></i> อนุมัติการคืนครุภัณฑ์</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger fw-bold">โปรดยืนยันการตรวจสอบสภาพครุภัณฑ์ก่อนการอนุมัติการคืน</p>
                    <div class="mb-3">
                        <label class="form-label">รายการยืม:</label>
                        <input type="text" class="form-control fw-bold" id="loanInfoDisplay" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">เจ้าหน้าที่รับคืน:</label>
                        <input type="text" class="form-control text-primary" value="{{ request.user.get_full_name }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="statusReturn" class="form-label">สถานะการคืนครุภัณฑ์ (หลังตรวจสอบ):</label>
                        <select name="status_return" id="statusReturn" class="form-select border-primary">
                            <option value="not_damaged" selected>ไม่มีรายการชำรุด (ส่งคืนเข้าคลัง)</option>
                            <option value="damaged">ชำรุด (ส่งเข้าสถานะซ่อม/จำหน่าย)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="receiverNote" class="form-label">หมายเหตุเจ้าหน้าที่ (ถ้ามี):</label>
                        <textarea name="receiver_note" id="receiverNote" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary" onclick="this.disabled=true; this.innerHTML='<span class=\'spinner-border spinner-border-sm\'></span> กำลังยืนยัน';">ยืนยันการคืน</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="approvalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" id="approvalForm">
            {% csrf_token %}
            <input type="hidden" name="status" id="approvalStatus">
            <div class="modal-content">
                <div class="modal-header bg-success text-white" id="approvalModalHeader">
                    <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i> ยืนยันการดำเนินการ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ปิด"></button>
                </div>
                <div class="modal-body">
                    <p id="approvalMessage" class="fw-bold"></p>

                    <div class="mb-3 d-none" id="rejectionNoteWrapper">
                        <label for="rejectionNote" class="form-label text-danger fw-bold">หมายเหตุ (ระบุเหตุผลในการปฏิเสธ):</label>
                        <textarea name="note" id="rejectionNote" class="form-control border-danger" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" id="mainApprovalBtn" class="btn btn-primary" onclick="this.disabled=true; this.innerHTML='<span class=\'spinner-border spinner-border-sm\'></span> กำลังประมวลผล'; this.form.submit();">ยืนยัน</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="howToUseModal" tabindex="-1" aria-labelledby="howToUseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="howToUseModalLabel"><i class="bi bi-lightbulb-fill me-2"></i> วิธีใช้งาน: การอนุมัติรายการยืม/คืน (สำหรับเจ้าหน้าที่)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4>ขั้นตอนการทำงานในฐานะเจ้าหน้าที่ครุภัณฑ์</h4>
                
                <hr>
                
                <h5>1. อนุมัติการยืม (<span class="badge bg-success"><i class="bi bi-check-lg"></i></span>)</h5>
                <p>ใช้กับรายการที่มีสถานะ <span class="badge bg-warning text-dark">รออนุมัติ</span> เมื่อคุณตรวจสอบแล้วว่าครุภัณฑ์พร้อมและสามารถให้ยืมได้</p>
                <ol>
                    <li>คลิกปุ่ม <span class="badge bg-success"><i class="bi bi-check-lg"></i></span></li>
                    <li>หน้าต่าง **ยืนยันการดำเนินการ** จะปรากฏขึ้น ตรวจสอบความถูกต้อง แล้วคลิก **ยืนยัน**</li>
                    <li>สถานะจะเปลี่ยนเป็น <span class="badge bg-success">กำลังยืม</span> และผู้ยืมสามารถนำครุภัณฑ์ไปใช้งานได้</li>
                </ol>

                <hr>

                <h5>2. ปฏิเสธการยืม (<span class="badge bg-danger"><i class="bi bi-x-lg"></i></span>)</h5>
                <p>ใช้กับรายการที่มีสถานะ <span class="badge bg-warning text-dark">รออนุมัติ</span> หากครุภัณฑ์ไม่พร้อม, มีการจองซ้อน หรือไม่เป็นไปตามเงื่อนไข</p>
                <ol>
                    <li>คลิกปุ่ม <span class="badge bg-danger"><i class="bi bi-x-lg"></i></span></li>
                    <li>หน้าต่างยืนยันจะปรากฏขึ้น **กรุณาระบุเหตุผล** ในช่อง **หมายเหตุ**</li>
                    <li>คลิก **ยืนยัน** สถานะจะเปลี่ยนเป็น <span class="badge bg-danger">ปฏิเสธ</span> และรายการจะถูกแจ้งไปยังผู้ยืม</li>
                </ol>
                
                <hr>

                <h5>3. อนุมัติการคืน (<span class="badge bg-primary"><i class="bi bi-clipboard-check"></i> คืน</span>)</h5>
                <p>ใช้กับรายการที่มีสถานะ <span class="badge bg-info text-dark">รออนุมัติคืน</span> เมื่อผู้ยืมนำครุภัณฑ์มาคืนและคุณได้ตรวจสอบสภาพแล้ว</p>
                <ol>
                    <li>คลิกปุ่ม <span class="badge bg-primary"><i class="bi bi-clipboard-check"></i> คืน</span></li>
                    <li>เลือก **สถานะการคืนครุภัณฑ์**:
                        <ul>
                            <li>**ไม่มีรายการชำรุด:** ครุภัณฑ์จะกลับเข้าสู่สถานะ **พร้อมใช้งาน**</li>
                            <li>**ชำรุด:** ครุภัณฑ์จะถูกตั้งสถานะเป็น **ชำรุด** หรือ **กำลังซ่อม** โดยอัตโนมัติ (ขึ้นอยู่กับการตั้งค่าระบบหลังบ้าน)</li>
                        </ul>
                    </li>
                    <li>คลิก **ยืนยันการคืน** สถานะจะเปลี่ยนเป็น <span class="badge bg-secondary">คืนแล้ว</span></li>
                </ol>

                <hr>
                
                <h5>4. แจ้งเตือนเกินกำหนด (<span class="badge bg-danger"><i class="bi bi-bell-fill"></i></span>)</h5>
                <p>ใช้กับรายการที่มีสถานะ <span class="badge bg-danger">เกินกำหนด</span> เพื่อส่งการแจ้งเตือนไปยังผู้ยืมผ่านช่องทางที่กำหนด (เช่น Line Notify)</p>

                <hr>

                <h5>5. ดูรายละเอียด (<span class="badge bg-info"><i class="bi bi-eye"></i></span>)</h5>
                <p>ใช้ได้กับทุกสถานะเพื่อดูข้อมูลเชิงลึกของรายการยืมครุภัณฑ์</p>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // ------------------------------------
    // 1. Logic สำหรับ Modal อนุมัติ/ปฏิเสธการยืม
    // ------------------------------------
    var approvalModal = document.getElementById('approvalModal');
    approvalModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var action = button.getAttribute('data-action');
        var url = button.getAttribute('data-url');
        var modalTitle = approvalModal.querySelector('.modal-header');
        var mainApprovalBtn = document.getElementById('mainApprovalBtn');

        var form = document.getElementById('approvalForm');
        var statusInput = document.getElementById('approvalStatus');
        var message = document.getElementById('approvalMessage');
        var noteWrapper = document.getElementById('rejectionNoteWrapper');
        var rejectionNote = document.getElementById('rejectionNote');

        form.action = url;
        statusInput.value = action;
        rejectionNote.value = ''; // Clear previous note

        if (action === "approved") {
            message.textContent = "คุณต้องการอนุมัติการยืมรายการนี้ใช่หรือไม่?";
            modalTitle.className = 'modal-header bg-success text-white';
            mainApprovalBtn.className = 'btn btn-success';
            noteWrapper.classList.add("d-none");
            rejectionNote.removeAttribute('required'); // Remove required for approve
        } else if (action === "rejected") {
            message.textContent = "คุณต้องการปฏิเสธการยืมรายการนี้ใช่หรือไม่?";
            modalTitle.className = 'modal-header bg-danger text-white';
            mainApprovalBtn.className = 'btn btn-danger';
            noteWrapper.classList.remove("d-none");
            rejectionNote.setAttribute('required', 'required'); // Set required for reject
        }
        
        // รีเซ็ตปุ่มก่อนเปิด Modal
        mainApprovalBtn.disabled = false;
        mainApprovalBtn.innerHTML = 'ยืนยัน';
    });

    // ------------------------------------
    // 2. Logic สำหรับ Modal อนุมัติการคืน
    // ------------------------------------
    var returnModal = document.getElementById('returnModal');
    var returnForm = document.getElementById('returnForm');
    
    returnModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var loanId = button.getAttribute('data-loan-id');
        var loanUser = button.getAttribute('data-loan-user');
        var loanInfoDisplay = document.getElementById('loanInfoDisplay');
        
        // Dynamic URL for Django form action (ถ้าใช้ action เดียวกับ loan_approval)
        // ถ้าใช้ URL แยกสำหรับการคืน ให้เปลี่ยนตรงนี้:
        returnForm.action = `/assets/approve-return/${loanId}/`; 

        // ใส่ค่า loan_id ลง hidden input
        document.getElementById('modalLoanId').value = loanId;

        // ปรับ title ให้ user-friendly
        document.getElementById('returnModalTitle').textContent = `อนุมัติการคืน #${loanId} (${loanUser})`;
        loanInfoDisplay.value = `#${loanId} โดยคุณ ${loanUser}`;
    });
});
</script>
{% endblock %}